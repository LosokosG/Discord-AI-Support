---
import Layout from "../../layouts/Layout.astro";
import { createSupabaseServerInstance } from "../../db/supabase.server";

// Ta strona bÄ™dzie potrzebna w przypadku bezpoÅ›redniego przekierowania z Discord
// zamiast przez Supabase Auth (np. podczas testÃ³w lokalnych)

export const prerender = false;

const { cookies, request } = Astro;
const url = new URL(request.url);
const code = url.searchParams.get("code");
const errorParam = url.searchParams.get("error");
const errorDescription = url.searchParams.get("error_description");

console.log("ðŸ“¢ [callback.astro] Otrzymany kod autoryzacyjny:", code ? "Tak (otrzymano kod)" : "Nie (brak kodu)");
console.log("ðŸ“¢ [callback.astro] URL:", url.toString());

// JeÅ›li otrzymano bÅ‚Ä…d z Discord OAuth
if (errorParam) {
  console.error("ðŸ“¢ [callback.astro] BÅ‚Ä…d OAuth:", errorParam, errorDescription);
  return Astro.redirect(`/auth/login?error=${encodeURIComponent(errorDescription || errorParam)}`);
}

let error = null;

if (code) {
  const supabase = createSupabaseServerInstance({
    cookies,
    headers: request.headers,
  });

  try {
    console.log("ðŸ“¢ [callback.astro] PrÃ³ba wymiany kodu na sesjÄ™");

    // WymieÅ„ kod na sesjÄ™
    const result = await supabase.auth.exchangeCodeForSession(code);

    if (result.error) {
      console.error("ðŸ“¢ [callback.astro] BÅ‚Ä…d wymiany kodu:", result.error);
      error = result.error.message;
    } else {
      // SprawdÅºmy sesjÄ™ zaraz po wymianie kodu
      const { data: sessionData } = await supabase.auth.getSession();

      if (sessionData.session) {
        console.log("ðŸ“¢ [callback.astro] Sesja utworzona pomyÅ›lnie");

        // Przekieruj do dashboardu
        return Astro.redirect("/dashboard");
      } else {
        console.error("ðŸ“¢ [callback.astro] Brak sesji po wymianie kodu");
        error = "Nie udaÅ‚o siÄ™ utworzyÄ‡ sesji uÅ¼ytkownika";
      }
    }
  } catch (err) {
    console.error("ðŸ“¢ [callback.astro] BÅ‚Ä…d podczas wymiany kodu:", err);
    error = "BÅ‚Ä…d systemu autentykacji";
  }

  if (error) {
    return Astro.redirect(`/auth/login?error=${encodeURIComponent(error)}`);
  }
}
---

<Layout title="Autoryzacja | Discord Bot">
  <div class="container flex items-center justify-center min-h-[calc(100vh-8rem)] py-8">
    <div class="text-center">
      <h1 class="text-2xl font-bold mb-4">Trwa przetwarzanie autoryzacji...</h1>
      <p class="text-muted-foreground">Przekierowujemy CiÄ™ do aplikacji.</p>

      {
        code ? (
          <p class="mt-4">Autoryzacja powiodÅ‚a siÄ™, nastÄ™puje przekierowanie...</p>
        ) : (
          <p class="mt-4 text-destructive">
            Nie otrzymano kodu autoryzacyjnego.{" "}
            <a href="/auth/login" class="underline">
              SprÃ³buj zalogowaÄ‡ siÄ™ ponownie
            </a>
            .
          </p>
        )
      }
    </div>
  </div>
</Layout>
